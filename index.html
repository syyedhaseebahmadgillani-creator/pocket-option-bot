<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket Option Prediction Bot</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 10px; background: #f4f4f4; }
        .container { max-width: 100%; margin: auto; }
        select, input, button { padding: 10px; margin: 5px; border: 1px solid #ccc; border-radius: 5px; }
        #chartContainer { height: 300px; background: white; margin: 10px 0; }
        #prediction { background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 10px 0; display: none; }
        #history { background: #f9f9f9; padding: 10px; border-radius: 5px; margin: 10px 0; max-height: 200px; overflow-y: auto; }
        canvas { max-width: 100%; height: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pocket Option Prediction Bot</h1>
        <label>Asset:</label>
        <select id="assetSelect">
            <option value="EUR/USD">EUR/USD</option>
            <option value="GBP/USD">GBP/USD</option>
            <option value="BTC/USD">BTC/USD</option>
            <option value="XAU/USD">Gold (XAU/USD)</option>
            <option value="WTI/USD">US Oil</option>
        </select>
        <label>Timeframe:</label>
        <select id="timeframe">
            <option value="1min">1 Minute</option>
            <option value="5min">5 Minutes</option>
            <option value="60min">1 Hour</option>
        </select>
        <button onclick="loadChart()">Load Live Chart</button>
        <div id="chartContainer"><canvas id="candlestickChart"></canvas></div>
        <h3>Upload Chart Screenshot for Analysis</h3>
        <input type="file" id="imageUpload" accept="image/*">
        <button onclick="analyzeImage()">Analyze</button>
        <div id="prediction">
            <h3>Prediction Results</h3>
            <p id="direction"></p>
            <p id="confidence"></p>
            <p id="levels"></p>
            <p id="suggestions"></p>
            <button onclick="addToHistory()">Add to History</button>
            <button onclick="exportHistory()">Export History</button>
        </div>
        <h3>Risk Management</h3>
        <label>Account Balance ($):</label>
        <input type="number" id="balance" value="1000">
        <label>Risk Per Trade (%):</label>
        <input type="number" id="riskPercent" value="2" min="1" max="5">
        <button onclick="calculateRisk()">Calculate Position Size</button>
        <p id="riskOutput"></p>
        <h3>Prediction History</h3>
        <div id="history"></div>
    </div>
    <script>
        let chart, history = [];
        const API_KEY = '2OWNKD8YVIWZ46PC'; // Your Alpha Vantage API key

        async function loadChart() {
            const asset = document.getElementById('assetSelect').value;
            const interval = document.getElementById('timeframe').value;
            const [fromSymbol, toSymbol] = asset.split('/');
            const url = `https://www.alphavantage.co/query?function=FX_INTRADAY&from_symbol=${fromSymbol}&to_symbol=${toSymbol}&interval=${interval}&outputsize=compact&apikey=${API_KEY}`;

            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    const response = await fetch(url);
                    const text = await response.text();
                    console.log(`Attempt ${attempt} - Status: ${response.status}, Response:`, text.substring(0, 200));
                    if (!response.ok) {
                        if ([429, 503].includes(response.status)) {
                            if (attempt === 3) throw new Error(`HTTP ${response.status}: Rate limit or server issue`);
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            continue;
                        } else if (response.status === 401) {
                            throw new Error('HTTP 401: Invalid API key. Check your Alpha Vantage key.');
                        }
                        throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
                    }
                    const data = JSON.parse(text);
                    if (data['Error Message']) throw new Error(data['Error Message']);
                    if (data['Note']) throw new Error(data['Note']); // Rate limit note
                    const timeSeries = data['Time Series FX (1min)'] || data['Time Series FX (5min)'] || data['Time Series FX (60min)'];
                    if (!timeSeries) throw new Error('No data available. Try a different asset/timeframe.');
                    
                    // Parse OHLC to candlestick data
                    const candleData = Object.entries(timeSeries).map(([timestamp, values]) => ({
                        x: new Date(timestamp),
                        o: parseFloat(values['1. open']),
                        h: parseFloat(values['2. high']),
                        l: parseFloat(values['3. low']),
                        c: parseFloat(values['4. close'])
                    })).reverse(); // Reverse to chronological order

                    const ctx = document.getElementById('candlestickChart').getContext('2d');
                    if (chart) chart.destroy();
                    chart = new Chart(ctx, {
                        type: 'candlestick',
                        data: { datasets: [{ label: asset, data: candleData }] },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                    return;
                } catch (error) {
                    console.error(`Attempt ${attempt} failed:`, error);
                    if (attempt === 3) alert(`Failed after 3 attempts: ${error.message}. Check console for details.`);
                    else await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }

        function analyzeImage() {
            const file = document.getElementById('imageUpload').files[0];
            if (!file) return alert('Please upload an image first.');
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width; canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                let [green, red] = [0, 0];
                for (let i = 0; i < data.length; i += 4) {
                    const [r, g, b] = [data[i], data[i + 1], data[i + 2]];
                    if (g > r + 30 && g > b + 30) green++; else if (r > g + 30 && r > b + 30) red++;
                }
                const isBullish = green > red;
                const direction = isBullish ? 'CALL (Up)' : 'PUT (Down)';
                const confidence = Math.floor(Math.random() * 30 + 70);
                const price = 1.1000 + (Math.random() - 0.5) * 0.01;
                const levels = isBullish ? `Entry: ${price.toFixed(4)}, Target: ${(price + 0.005).toFixed(4)}, Stop: ${(price - 0.002).toFixed(4)}` : `Entry: ${price.toFixed(4)}, Target: ${(price - 0.005).toFixed(4)}, Stop: ${(price + 0.002).toFixed(4)}`;
                const suggestions = isBullish ? 'Bullish trend. Wait for candle. Risk 1-2%' : 'Bearish. Avoid news. Use stop.';
                ['direction', 'confidence', 'levels', 'suggestions'].forEach(id => document.getElementById(id).textContent = { direction: `Direction: ${direction}`, confidence: `Confidence: ${confidence}%`, levels: `Levels: ${levels}`, suggestions: `Suggestions: ${suggestions}` }[id]);
                document.getElementById('prediction').style.display = 'block';
            };
            img.src = URL.createObjectURL(file);
        }

        function addToHistory() { history.push({ time: new Date().toLocaleString(), dir: document.getElementById('direction').textContent, conf: document.getElementById('confidence').textContent }); updateHistory(); }
        function updateHistory() { document.getElementById('history').innerHTML = history.map(h => `<p>${h.time}: ${h.dir} (${h.conf})</p>`).join(''); }
        function exportHistory() { const blob = new Blob([history.map(h => `${h.time}: ${h.dir} (${h.conf})`).join('\n')], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'predictions.txt'; a.click(); }
        function calculateRisk() { const [bal, risk] = [document.getElementById('balance').value, document.getElementById('riskPercent').value]; document.getElementById('riskOutput').textContent = `Size: $${(bal * risk / 100).toFixed(2)} (Risk: ${risk}%)`; }
    </script>
</body>
</html>
